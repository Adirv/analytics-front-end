<!DOCTYPE html>
<html lang="en">
<head>
  <base href="/">
  <meta charset="UTF-8">
  <title>Analytics Loader</title>
  <style>
    body {
      margin: 0;
      overflow-x: hidden;
    }

    h1 {
      text-align: center;
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    }
    button {
      width: 160px;
      height: 32px;
      font-size: 16px;
      margin-left: 12px;
    }
    iframe {
      width: 100%;
      height: 100vh;
      border: 0;
      transition: height 0.3s;
    }
  </style>
</head>
<body>
<div style="display: flex; align-items: center; width: 100%; justify-content: center">
  <h1>External app loading Analytics in an iframe with custom style</h1>
  <button id="btn">Toggle Contrast</button>
</div>
<iframe id="analytics" src="http://localhost:4200"></iframe>
<script>
  const config = {
    kalturaServer: {
      uri: 'www.kaltura.com',
      previewUIConf: 44299511,
    },
    cdnServers: {
      serverUri: 'http://cdnapi.kaltura.com',
      securedServerUri: 'https://cdnapisec.kaltura.com'
    },
    ks: "",
    pid: "",
    locale: 'en',
    live: {
      pollInterval: 30,
      healthNotificationsCount: 50,
    },
    menuConfig: {
      showMenu: true,
    },
    customStyle: {
        baseClassName: 'webcasting',
        css: `
            body.webcasting {
                background: black;
                background-color: black;
            }
            .webcasting .kMain .kReportView .kReport {
                background: transparent;
                background-color: black !important;
            }
            .webcasting .kMain .kReportView .kReport .kTotalsRow {
                background: transparent;
            }
            .webcasting .kMain .kReportView .kReport .kFilters {
                background-color: white;
            }
            .webcasting .kMain .kReportView .kReport .kReportHeader {
                background: transparent;
            }
            .webcasting .kMain .kReportView .kReport .kReportContainer {
                background: transparent;
            }
            .webcasting .kMain .kReportView .kReport .kEntryDetails {
                background: transparent;
            }
            .webcasting .kMain .kReportView .kReport.kImageReport {
                background: transparent;
            }
            .webcasting .kMain .kReportView .kReport app-entry-filter {
                background: transparent;
            }
            /* Margins */
            .webcasting .kContent {
                width: 100% !important;
            }
            .webcasting .kReportView .kContent {
                padding-left: 20px !important;
                padding-right: 20px !important;
                box-sizing: border-box;
            }
            /* Colors */
            .kLiveUsers .kHeader, .kUsersBandwidth .kHeader, .webcasting .kMain .kReportView .kReport .kFilters .kTitle, app-horizontal-bar-row .kBarContainer .kLabel, .kBarContainer .kBarWrapper .kBarWrapperRow .kValue, .kSummaryRow .kRightSide, p-table .ui-table .ui-table-tbody > tr > td, p-table tr.kSummaryRow th {
              color: white !important;
            }
            .kLineCover{
              background: -moz-linear-gradient(top, rgba(0,0,0,0) 0%, rgba(0,0,0,1) 62%, rgba(0,0,0,1) 100%) !important;
              background: -webkit-linear-gradient(top, rgba(0,0,0,0) 0%,rgba(0,0,0,1) 62%,rgba(0,0,0,1) 100%) !important;
              background: linear-gradient(to bottom, rgba(0,0,0,0) 0%,rgba(0,0,0,1) 62%,rgba(0,0,0,1) 100%) !important;
            }
            kScrollToTopContainer, .kChartContainer, p-table .ui-table .ui-table-tbody > tr {
              background-color: black !important;
            }
            .webcasting .kMain .kReportView .kReport .kFilters, .kMain .kReportView .kReport .kReportContent {
              background-color: black;
            }
            .webcasting .kMain .kReportView .kReport .kFilters.kPreset, .webcasting .kMain .kReportView .kReport .kFilters.kSpecific  {
              background-color: white;
            }
            `
    }
  };

  document.addEventListener('DOMContentLoaded', () => {
    const analyticsApp = document.getElementById('analytics');
    const toggleContrastBtn = document.getElementById('btn');

    const sendMessage = message => {
      if (analyticsApp && analyticsApp.contentWindow && analyticsApp.contentWindow.postMessage) {
        analyticsApp.contentWindow.postMessage(message, '*'); // use window.location.origin in your app instead
      }
    };

    toggleContrastBtn.addEventListener('click', e => {
        sendMessage({ messageType: 'toggleContrastTheme' });
    });

    window.addEventListener('message', e => {
      if (!e.data) {
        return;
      }

      const postMessageData = e.data;

      switch (postMessageData.messageType) {
        case 'analyticsInit':
          sendMessage({ messageType: 'init', payload: config });
          break;

        case 'analyticsInitComplete':
          sendMessage({ messageType: 'navigate', payload: { url: '/analytics/live' } });
          sendMessage({ messageType: 'updateFilters', payload: { queryParams: { dateBy: 'last30days' } } });
          break;

        case 'updateLayout':
          analyticsApp.style.height = `${postMessageData.payload.height}px`;
          break;

        case 'navigateTo':
          const [url, params] = postMessageData.payload.split('?');
          const queryParams = params.split('&').reduce((acc, val) => {
            const [key, value] = val.split('=');
            acc[key] = value;
            return acc;
          }, {});

          sendMessage({'messageType': 'navigate', payload: { url, queryParams }});
          sendMessage({'messageType': 'updateFilters', payload: { queryParams }});
          break;

        default:
          console.log(`${postMessageData.messageType} event is not implemented`);
          break;
      }
    })
  });
</script>
</body>
</html>
